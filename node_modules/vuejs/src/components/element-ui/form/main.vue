<template>
    <div class="nftn-el-form">
        <el-form
            ref="form"
            v-bind:label-position="labelPosition"
            v-bind:label-width="labelWidth + 'px'"
            v-bind:model="formData">
            <nftn-el-grid v-bind:configs="grid">
                <template
                    v-for="(slot, sloti) in computedInputGridSlots"
                    v-bind:slot="'grid-' + slot.name">
                    <el-row v-bind:gutter="grid.gap">
                        <el-col
                            v-for="(input, inputi) in slot.inputs"
                            v-bind:key="'input:' + inputi"
                            v-bind:span="input.span || 24">
                            <nftn-el-input
                                ref="input"
                                v-bind:configs="input"
                                v-model="formData[input.name]"
                                v-if="!computedGridSlots['grid-' + slot.name]">
                                <template slot="label" v-if="$slots[input.name + '.label']">
                                    <slot v-bind:name="input.name + '.label'"></slot>
                                </template>
                                <template slot="input" v-if="$slots[input.name + '.input']">
                                    <slot v-bind:name="input.name + '.input'"></slot>
                                </template>
                            </nftn-el-input>
                        </el-col>
                    </el-row>
                </template>
                <template
                    v-for="(slot, sloti) in computedGridSlots"
                    v-bind:slot="slot">
                    <slot v-bind:name="slot"></slot>
                </template>
                <template v-bind:slot="'grid-' + actionGridSlot">
                    <el-button type="primary" v-on:click="handleSubmit">提交</el-button>
                    <el-button v-on:click="handleReset">重置</el-button>
                </template>
            </nftn-el-grid>
        </el-form>
    </div>
</template>

<script>
    import ObjectHelper from '@/helpers/object';
    import Vue from 'vue';
    import Element from 'element-ui';
    import NftnElInput from './input';
    import '../grid';

    Vue.use(Element);

    let watchers = [];

    export default {
        name: 'nftn-el-form',
        components: {
            NftnElInput
        },
        props: {
            grid: {
                type: [Object, Array],
                default () { return {}; }
            },
            actionGridSlot: {
                type: String,
                default () {
                    let grid = this.grid.rows;
                    let rows = grid instanceof Array ? grid : grid.rows;
                    let cols = [rows.length - 1].cols instanceof Array ? rows[rows.length - 1].cols : rows[rows.length - 1];
                    return (rows.length - 1) + '-' + (cols.length - 1);
                }
            },
            labelPosition: {
                type: String,
                default: 'top'
            },
            labelWidth: {
                type: Number,
                default: 80
            },
            inputs: {
                type: Array,
                default () { return []; }
            },
            rules: {
                type: Object,
                default () { return {}; }
            },
            emptyNoPost: {
                type: Boolean,
                default: false
            },
            value: { // v-model
                type: Object,
                default () { return {}; }
            }
        },
        methods: {
            getGridSlots () {
                let slots = [];
                let result = {};
                let existsRules = {};

                this.inputs.forEach(input => {
                    let gridSlot = input.grid || '0-0';
                    if (slots.indexOf(gridSlot) === -1) {
                        slots.push(gridSlot);
                        result[gridSlot] = { name: gridSlot, inputs: [] };
                    }
                    let rules = this.rules[input.name];
                    if (rules && !existsRules[input.name]) {
                        if (!input.rules) {
                            input.rules = [];
                        } else if (typeof input.rules === 'object' && !(input.rules instanceof Array)) {
                            input.rules = [input.rules];
                        }

                        if (rules instanceof Array) {
                            input.rules = input.rules.concat(rules);
                        } else {
                            input.rules.push(rules);
                        }
                        existsRules[input.name] = input.rules;
                    }
                    if (this.emptyNoPost === true && input.emptyNoPost !== false) {
                        input.emptyNoPost = true;
                    }
                    result[gridSlot].inputs.push(input);
                });

                return result;
            },
            handleSubmit () {
                this.$refs['form'].validate(valid => {
                    if (valid) {
                        Promise.all(this.$refs['input'].map(input => { return input.beforeSubmit(); })).then(result => {
                            // console.log('提交...');
                            this.$refs['form'].$el.submit();
                        }).catch(errors => {
                            console.log('提交失败', errors);
                        });
                    } else {
                        // this.$refs['form'].$el.submit();
                        return false;
                    }
                });
            },
            handleReset () {
                this.reset = true;
                this.$refs['form'].resetFields();
                let formData = JSON.parse(JSON.stringify(Object.assign(this.formData, this.resetData)));
                this.inputs.forEach(input => {
                    let inputname = input.name;
                    let inputvalue = formData[inputname];
                    if ((JSON.stringify(inputvalue) === '[]' || inputvalue === '') && input.value !== undefined) {
                        formData[inputname] = input.value;
                    }
                });
                this.formData = formData;
                setTimeout(() => {
                    this.reset = false;
                }, 100);
            },
            isMultipleInput (input) {
                return ['checkbox', 'daterange', 'datetimerange'].indexOf(input.type) !== -1 || input.multiple;
            }
        },
        computed: {
            computedGridSlots () {
                // 提取父组件设置的 slots 里关于 grid 的部分
                return Object.keys(this.$slots).filter(slot => slot.indexOf('grid-') === 0);
            },
            computedInputGridSlots () {
                // 根据表单项的设置自动生成 grid slots 并排除父组件设置的 grid slots
                let slots = this.getGridSlots();
                let slotKeys = Object.keys(slots);
                slotKeys.forEach(slot => {
                    if (this.computedGridSlots.indexOf('grid-' + slot) >= 0) {
                        delete slots[slot];
                    }
                });
                return slots;
            }
        },
        data () {
            return {
                formData: this.value,
                reset: false,
                resetData: this.value
            };
        },
        watch: {
            inputs: {
                handler (newValue, oldValue) {
                    // 由于监听整个表单项列表，这里需要将所有的监听释放
                    watchers.forEach(unwatcher => {
                        if (typeof unwatcher === 'function') {
                            unwatcher();
                        };
                    });

                    // 读取表单数据
                    let formData = JSON.parse(JSON.stringify(this.formData));
                    this.inputs.forEach(input => {
                        let inputname = input.name;
                        let inputvalue = formData[inputname];
                        // <-- 初始化表单项数据
                        if (inputname && inputvalue === undefined) {
                            formData[inputname] = '';
                            if (['slider'].indexOf(input.type) !== -1) {
                                formData[inputname] = input.min;
                            }
                        }

                        if (this.isMultipleInput(input)) {
                            formData[inputname] = (!(inputvalue instanceof Array) && inputvalue !== null && inputvalue !== undefined && inputvalue !== '') ? [inputvalue] : (inputvalue || []);
                        } else if (inputvalue instanceof Array) {
                            formData[inputname] = inputvalue[0];
                        }
                        // 初始化表单项数据 -->

                        let cascade = input.cascade || {};
                        if (cascade && cascade.parent) {
                            let handleCascade = (value) => {
                                if (value) {
                                    let pinput = this.inputs.filter(pinput => {
                                        return pinput.name === cascade.parent;
                                    })[0];
                                    if (pinput) {
                                        let pinputSelectedItem = pinput.datasource.filter(item => {
                                            return JSON.stringify(item[pinput.valueKey || 'value']) === JSON.stringify(value);
                                        })[0];
                                        if (pinputSelectedItem) {
                                            let datasource = ObjectHelper.deep.getValue(pinputSelectedItem, cascade.key);
                                            if (!datasource) {
                                                datasource = ObjectHelper.deep.getValue(window, cascade.key);
                                            }
                                            if (datasource instanceof Array) {
                                                input.datasource = datasource;
                                            }
                                        }
                                    }
                                } else {
                                    formData[inputname] = input.multiple ? [] : '';
                                }
                            };
                            // 监听父数据的变化
                            watchers.push(this.$watch('formData.' + cascade.parent, (nv, ov) => {
                                // 清空当前数据值
                                // 清空当前数据项
                                // 加载新数据源
                                formData[inputname] = input.multiple ? [] : '';
                                input.datasource = [];
                                handleCascade(nv);
                            }));
                            handleCascade(formData[cascade.parent]);
                        }

                        let rules = input.rules;
                        if (rules instanceof Array && rules.length) {
                            watchers.push(this.$watch('formData.' + inputname, (nv, ov) => {
                                if (!this.reset && JSON.stringify(nv) !== JSON.stringify(ov)) {
                                    this.$refs['form'].validateField(inputname);
                                }
                            }));
                        }
                    }); // this.inputs.forEach()

                    this.formData = formData;
                },
                deep: true,
                immediate: true
            },
            formData: {
                handler (newValue, oldValue) {
                    this.$emit('input', newValue);
                },
                deep: true
            }
        }, // watch {}
        created () {},
        mounted () {
            this.handleReset();
        }
    };
</script>
