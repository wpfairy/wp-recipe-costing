<template>
    <el-form-item
        v-bind:label="computedConfigs.label"
        v-bind:prop="computedConfigs.name"
        v-bind:rules="computedConfigs.rules"
        v-bind:error="inputError"
        v-bind:show-message="true">
        <template slot="label">
            <slot name="label">
                {{ computedConfigs.label + '&nbsp;' }}
            </slot>
        </template>
        <slot name="input">
            <el-radio-group
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-if="computedConfigs.type === 'radio'">
                <el-radio class="radio"
                    v-for="(each, eachi) in computedConfigs.datasource"
                    v-bind:key="eachi"
                    v-bind:name="computedPostName"
                    v-bind:label="each[computedConfigs.valueKey]"
                    v-bind:disabled="each.disabled">
                    {{ each[computedConfigs.labelKey] }}
                </el-radio>
            </el-radio-group>
            <el-checkbox-group
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-bind:min="computedConfigs.min"
                v-bind:max="computedConfigs.max"
                v-else-if="computedConfigs.type === 'checkbox'">
                <el-checkbox
                    v-for="(each, eachi) in computedConfigs.datasource"
                    v-bind:key="eachi"
                    v-bind:name="computedPostName"
                    v-bind:label="each[computedConfigs.valueKey]"
                    v-bind:disabled="each.disabled">
                    {{ each[computedConfigs.labelKey] }}
                </el-checkbox>
            </el-checkbox-group>
            <el-select
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-bind:multiple="computedConfigs.multiple"
                v-bind:multiple-limit="computedConfigs.max"
                v-bind:clearable="computedConfigs.clearable"
                v-bind:loading="loading"
                v-else-if="computedConfigs.type === 'select'">
                <el-option
                    v-for="(each, eachi) in computedConfigs.datasource"
                    v-bind:key="eachi"
                    v-bind:label="each[computedConfigs.labelKey]"
                    v-bind:value="each[computedConfigs.valueKey]"
                    v-bind:disabled="each.disabled">
                </el-option>
            </el-select>
            <el-date-picker
                v-bind:type="computedConfigs.type"
                v-bind:format="computedConfigs.format"
                v-model="inputValue"
                v-bind:editable="false"
                v-bind:disabled="computedConfigs.disabled"
                v-else-if="computedConfigs.type.indexOf('date') === 0">
            </el-date-picker>
            <el-switch
                v-bind:on-text="computedConfigs.onText"
                v-bind:off-text="computedConfigs.offText"
                v-bind:on-value="computedConfigs.onValue"
                v-bind:off-value="computedConfigs.offValue"
                v-bind:on-color="computedConfigs.onColor"
                v-bind:off-color="computedConfigs.offColor"
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-else-if="computedConfigs.type === 'switch'">
            </el-switch>
            <el-slider
                v-bind:min="computedConfigs.min"
                v-bind:max="computedConfigs.max"
                v-bind:step="computedConfigs.step"
                v-bind:show-input="computedConfigs.showInput"
                v-bind:show-stops="computedConfigs.showStops"
                v-bind:show-tooltip="computedConfigs.showTooltip"
                v-bind:range="computedConfigs.range"
                v-bind:vertical="computedConfigs.vertical"
                v-bind:height="computedConfigs.height"
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-else-if="computedConfigs.type === 'slider'">
            </el-slider>
            <div class="moxie-file-input"
                v-else-if="computedConfigs.type === 'file'">
                <el-row v-bind:gutter="computedConfigs.fileGrid.gap">
                    <el-col
                        v-bind:style="{ marginBottom: computedConfigs.fileGrid.gap + 'px' }"
                        v-bind:span="computedConfigs.fileGrid.span"
                        v-for="(file, findex) in this.computedFiles"
                        v-bind:key="findex">
                        <moxie-preview
                            v-bind:file="file"
                            v-bind:ratio="computedConfigs.ratio"
                            v-bind:bg-size="computedConfigs.bgSize"
                            v-bind:url-append="computedConfigs.fileUrlAppend"
                            v-bind:preview-append="computedConfigs.filePreviewAppend"
                            v-bind:data="findex"
                            v-bind:on-click="computedConfigs.onFileClick"
                            v-bind:on-error="computedConfigs.onFilePreviewError">
                        </moxie-preview>
                    </el-col>
                    <el-col
                        v-bind:span="computedConfigs.fileGrid.span"
                        v-bind:class="{ 'fixed-hide': computedFileChooseable === false }">
                        <moxie-file
                            ref="file"
                            v-bind:ratio="computedConfigs.ratio"
                            v-bind:disabled="computedConfigs.disabled"
                            v-bind:extensions="computedConfigs.extensions"
                            v-bind:multiple="computedConfigs.multiple"
                            v-bind:max="computedConfigs.max"
                            v-bind:action="computedConfigs.action"
                            v-bind:post-data="computedConfigs.filePostData"
                            v-bind:file-key="computedConfigs.fileKey"
                            v-bind:response-read="computedConfigs.responseRead"
                            v-bind:on-error="computedConfigs.onFileChooseError"
                            v-model="inputValue">
                        </moxie-file>
                    </el-col>
                </el-row>
            </div>
            <el-input
                v-bind:type="computedConfigs.type"
                v-bind:name="computedPostName"
                v-bind:rows="computedConfigs.rows"
                v-model="inputValue"
                v-bind:disabled="computedConfigs.disabled"
                v-else
            ></el-input>
            <input
                v-for="(input, index) in computedHiddens"
                v-bind:key="index"
                type="hidden"
                v-bind:name="computedPostName"
                v-bind:value="input.split ? inputValue[index] : inputValue" />
            <input
                type="hidden"
                v-for="(input, index) in [].concat(inputValue)"
                v-bind:key="index"
                v-bind:name="computedPostName"
                v-bind:value="typeof input !== 'object' ? input : input.value"
                v-if="computedConfigs.type === 'file'" />
        </slot>
    </el-form-item>
</template>

<script>
    import Vue from 'vue';
    import Element from 'element-ui';
    import ElementDateUtils from 'element-ui/src/utils/date';
    import MoxieFile from '@/components/moxie/file';
    import MoxiePreview from '@/components/moxie/preview';

    Vue.use(Element);

    let __instances = {};
    let __instance = null;

    export default {
        name: 'nftn-el-input',
        components: {
            MoxieFile,
            MoxiePreview
        },
        props: {
            grid: {
                type: String,
                default: '0-0'
            },
            label: {
                type: String
            },
            type: {
                type: String,
                default: 'vValue'
            },
            name: {
                type: String
            },
            configs: {
                type: Object,
                default () { return {}; }
            },
            value: { // v-model
                default: ''
            },
            emptyNoPost: {
                type: Boolean,
                default: false
            },
            rules: {
                type: Array,
                default: null
            },
            errors: {
                type: Array,
                default () { return []; }
            },
            disabled: {
                type: Boolean,
                default: false
            },
            // 特殊选项
            datasource: { // type="radio | checkbox | select"
                type: Array,
                default: null
            },
            labelKey: { // type="radio | checkbox | select"
                type: String,
                default: 'name'
            },
            valueKey: { // type="radio | checkbox | select"
                type: String,
                default: 'value'
            },
            rows: { // type='textarea'
                type: Number,
                default: 3
            },
            min: { // type='checkbox | slider'
                type: Number
            },
            max: { // type='checkbox | select | slider | file'
                type: Number
            },
            multiple: { // type='select | file'
                type: Boolean,
                default: false
            },
            clearable: { // type='select'
                type: Boolean,
                default: true
            },
            format: { // type='date | datetime'
                type: String,
                default: ''
            },
            onText: { // type='switch'
                type: String,
                default: '开'
            },
            offText: { // type='switch'
                type: String,
                default: '关'
            },
            onValue: { // type='switch'
                default: true
            },
            offValue: { // type='switch'
                default: false
            },
            onColor: { // type='switch'
                type: String,
                default: '#20A0FF'
            },
            offColor: { // type='switch'
                type: String,
                default: '#C0CCDA'
            },
            step: { // type='slider'
                type: Number,
                default: 1
            },
            showInput: { // type='slider'
                type: Boolean,
                default: false
            },
            showStops: { // type='slider'
                type: Boolean,
                default: false
            },
            showTooltip: { // type='slider'
                type: Boolean,
                default: true
            },
            range: { // type='slider'
                type: Boolean,
                default: false
            },
            vertical: { // type='switch'
                type: Boolean,
                default: false
            },
            height: { // type='switch'
                type: String,
                default: '100px'
            },
            ratio: { // type='file'
                type: String,
                default: '1:1'
            },
            bgSize: { // type='file'
                type: String,
                default: 'cover'
            },
            fileGrid: { // type='file'
                type: Object,
                default () {
                    return { gap: 10, span: 24 };
                }
            },
            fileUrlAppend: { // type='file'
                type: String,
                default: ''
            },
            filePreviewAppend: { // type='file'
                type: String,
                default: ''
            },
            extensions: { // type='file'
                type: String,
                default: '*'
            },
            filePostData: {
                type: Object,
                default () { return {}; }
            },
            fileKey: {
                type: String,
                default: 'file'
            },
            responseRead: {
                type: String,
                default: ''
            },
            onChange: {
                type: Function,
                default (value) {
                    __instance.$emit('input', value);
                }
            },
            onFileClick: {
                type: Function,
                default (file, index) {
                    this.$confirm('确定删除此文件吗？', '提示', {
                        type: 'warning'
                    }).then(() => {
                        if (this.computedConfigs.multiple) {
                            this.inputValue.splice(index, 1);
                        } else {
                            this.inputValue = '';
                        }
                        this.$message({ type: 'success', message: '成功删除' });
                    }).catch(() => {
                        this.$message({ type: 'info', message: '取消删除' });
                    });
                }
            },
            onFileChooseError: {
                type: Function,
                default (errors, errFiles) {
                    [].concat(errors).forEach(error => {
                        setTimeout(() => {
                            this.$notify({
                                type: 'error',
                                message: error.message || error
                            });
                        });
                    });
                }
            },
            onFilePreviewError: {
                type: Function
            }
        }, // props {}
        computed: {
            computedPostName () {
                let configs = this.computedConfigs;
                let result = configs.name;
                if (this.value === '' && configs.emptyNoPost === true) {
                    result = '';
                }
                return result;
            },
            computedConfigs () {
                let configs = Object.assign({}, this.$props, this.configs);
                Object.keys(configs).forEach(key => {
                    if (typeof configs[key] === 'function') {
                        configs[key] = configs[key].bind(this);
                    }
                });

                if (configs.type.indexOf('date') === 0) {
                    configs.format = configs.format || (configs.type.indexOf('time') > 0 ? 'yyyy-MM-dd HH:mm' : 'yyyy-MM-dd');
                }
                return configs;
            },
            computedHiddens () {
                let inputs = [];
                let type = this.computedConfigs.type;
                if (['date', 'datetime', 'daterange', 'datetimerange', 'select', 'switch', 'slider'].indexOf(type) !== -1) {
                    let input = { name: this.computedConfigs.name };
                    if (type.indexOf('range') > 0) {
                        input.split = true;
                        inputs.push(input);
                    }
                    inputs.push(input);
                }
                return inputs;
            },
            computedFileChooseable () {
                let configs = this.computedConfigs;
                if (configs.multiple) {
                    if (configs.max === 0) {
                        return true;
                    } else {
                        return this.inputValue.length < configs.max;
                    }
                }
                return !this.inputValue;
            },
            computedFiles () {
                let result = [];
                if (this.inputValue) {
                    result = result.concat(this.inputValue);
                }
                return result;
            }
        }, // computed {}
        data () {
            return {
                loading: false,
                inputValue: this.value,
                inputError: ''
            };
        }, // data ()
        methods: {
            beforeSubmit () {
                return new Promise((resolve, reject) => {
                    if (this.$refs['file']) {
                        this.$refs['file'].upload().then(result => {
                            resolve(result);
                        }).catch(error => {
                            reject(error);
                        });
                    } else {
                        resolve(true);
                    }
                });
            }
        },
        watch: {
            computedConfigs: {
                handler (newConfigs, oldConfigs) {
                    // let inputvalue = this.value;
                    let configs = newConfigs;
                    let datasource = configs.datasource;
                    if (datasource instanceof Array && datasource.length) {
                        // 确保数据源数据的结构正确
                        newConfigs.datasource = datasource.map(each => {
                            let result = {};
                            if (typeof each !== 'object') {
                                result[configs.labelKey] = each;
                                result[configs.valueKey] = each;
                            } else {
                                result = each;
                            }
                            return result;
                        });
                    }
                },
                immediate: true
            },
            inputValue (newValue, oldValue) {
                let type = this.computedConfigs.type;
                let value = newValue;
                if (type.indexOf('date') === 0 && value) {
                    let format = this.computedConfigs.format;

                    if (type.indexOf('range') !== -1) {
                        if (value[0] && value[1]) {
                            value = value.map(v => {
                                if (typeof v === 'string') {
                                    v = ElementDateUtils.parse(v, format);
                                }
                                return ElementDateUtils.format(v, format);
                            });
                        }
                    } else {
                        if (typeof value === 'string') {
                            value = ElementDateUtils.parse(value, format);
                        }
                        value = ElementDateUtils.format(value, format);
                    }
                }
                __instance = __instances[this._uid];
                if (typeof this.onChange === 'function') {
                    this.computedConfigs.onChange(value);
                }
            },
            value (newValue, oldValue) { // 监听 v-model 数据的变化
                if (JSON.stringify(newValue) !== JSON.stringify(oldValue)) {
                    this.inputValue = null;
                    this.inputValue = newValue;
                }
            }
        }, // watch {}
        created () {
            if (!__instances[this._uid]) {
                __instances[this._uid] = this;
            }
        },
        mounted () {}
    };
</script>

<style lang="less">
    .el-date-editor.el-input {
        width: 100%;
    }

    .fixed-hide {
        position: fixed;
        top: -99999px;
    }
</style>
