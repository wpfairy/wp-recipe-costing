<template>
    <nftn-moxie-container
        v-bind:ratio="computedConfigs.ratio">
        <a href="javascript:;" class="moxie-file"
            v-bind:class="{ disabled: computedConfigs.disabled }"
            v-file="{ refresh: inputRefresh, multiple: multiple, extensions: extensions, handleChange: handleChange }"></a>
    </nftn-moxie-container>
</template>

<script>
    import NftnMoxieContainer from './container';
    import ObjectHelper from '@/helpers/object';

    let __inputs = {};

    export default {
        name: 'nftn-moxie-file',
        components: {
            NftnMoxieContainer
        },
        props: {
            ratio: { // 关联 container.vue
                type: String,
                default: '1:1'
            },
            disabled: {
                type: Boolean,
                default: false
            },
            extensions: {
                type: String,
                default: '*'
            },
            size: {
                type: Number,
                default: 2 * 1024 * 1024
            },
            multiple: {
                type: Boolean,
                default: false
            },
            max: {
                type: Number,
                default: 0
            },
            action: {
                type: [String, Object]
            },
            postData: {
                type: Object,
                default () { return {}; }
            },
            fileKey: {
                type: String,
                default: 'file'
            },
            responseRead: {
                type: String,
                default: ''
            },
            onChange: {
                type: Function,
                default (files) {
                    let result = this.computedConfigs.multiple ? files : files[0];
                    this.$emit('input', result);
                }
            },
            onError: {
                type: Function,
                default (errors, files) {
                    alert([].concat(errors).map(error => { return error.message || error; }).join('\n') || '发生错误');
                }
            },
            value: { // v-model
                type: [String, Array, Object],
                default: ''
            },
            configs: {
                type: Object,
                default () { return {}; }
            }
        },
        computed: {
            computedConfigs () {
                let configs = Object.assign({}, this.$props, this.configs);
                Object.keys(configs).forEach(key => {
                    if (typeof configs[key] === 'function') {
                        configs[key] = configs[key].bind(this);
                    }
                });
                return configs;
            }
        },
        methods: {
            uploadPromise (file) {
                let configs = this.computedConfigs;
                return new Promise((resolve, reject) => {
                    if (file.uploading === true) {
                        file.error = '文件正在上传';
                        configs.onError('[' + file.name + '] 文件上传中。');
                        resolve(file);
                    } else if (!(file instanceof window.moxie.file.File) || file.uploaded === true) {
                        resolve(file);
                    } else {
                        let formData = new window.moxie.xhr.FormData();
                        Object.keys(configs.postData).forEach(key => {
                            formData.append(key, configs.postData[key]);
                        });
                        formData.append(configs.fileKey, file);

                        let xhr = new window.moxie.xhr.XMLHttpRequest();
                        xhr.onload = (response) => {
                            if (response.target.status.toString().substr(0, 1) !== '2') {
                                xhr.onerror();
                            } else {
                                delete file.error;
                                file.uploaded = true;
                                file.value = configs.responseRead ? ObjectHelper.deep.getValue(response.target.response, configs.responseRead) : response.target.response;
                            }
                            file.uploading = false;
                            resolve(file);
                        };
                        xhr.onerror = () => {
                            file.uploading = false;
                            file.error = '上传失败';
                            configs.onError('[' + file.name + '] 上传失败。');
                            resolve({ error: '上传失败。' });
                        };
                        xhr.open(configs.action.method || 'POST', configs.action);
                        xhr.responseType = 'json';
                        xhr.send(formData);
                        file.uploading = true;
                    }
                });
            },
            upload () {
                let files = [].concat(this.value);
                return new Promise((resolve, reject) => {
                    let promises = files.map(this.uploadPromise);
                    let errors = [];
                    Promise.all(promises).then(result => {
                        result.forEach(r => {
                            if (r.error) {
                                errors.push(r.error);
                            } else {
                                files[r.index] = r;
                            }
                        });

                        let emitValue = this.computedConfigs.multiple ? files : files[0];
                        this.$emit('input', emitValue);

                        if (errors.length) {
                            reject(errors);
                        } else {
                            resolve(result);
                        }
                    });
                });
            },
            validate (file) {
                if (file instanceof window.moxie.file.File) {
                    let configs = this.computedConfigs;
                    let extension = window.moxie.core.utils.Mime.getFileExtension(file.name);
                    if (configs.extensions !== '*' && configs.extensions.split(',').indexOf(extension) === -1) {
                        return { type: 'extension', message: '文件格式错误' };
                    } else if (file.size > configs.size) {
                        return { type: 'size', message: '文件数据过大' };
                    }
                }
                return true;
            },
            inputRefresh (input, options) {
                if (options instanceof Array) {
                    options.forEach(key => {
                        input.setOption(key, this[key]);
                    });
                }
                input.disable(this.computedConfigs.disabled);
                input.refresh();
            },
            handleChange (e) {
                let configs = this.computedConfigs;
                let files = [].concat(e.target.files);
                let result = this.value;
                let errors = [];

                if (!this.multiple) {
                    let valid = this.validate(files[0]);
                    if (valid === true) {
                        result = files;
                    } else {
                        errors.push(Object.assign(valid, { message: '[' + file.name + '] ' + valid.message }));
                    }
                } else {
                    if (!(result instanceof Array)) {
                        result = [].concat(result);
                    }

                    files.forEach((file, index) => {
                        let valid = this.validate(file);
                        if (valid !== true) {
                            errors.push(Object.assign(valid, { message: '[' + file.name + '] ' + valid.message + ', 系统自动移除。' }));
                        } else {
                            result.push(file);
                        }
                    });

                    let max = configs.max;
                    if (max > 0 && result.length > max) {
                        errors.push({ type: 'max', message: '数量不能大于' + max + '项,已自动移除' + (result.length - max) + '项。' });
                        result = result.splice(0, max);
                    }
                }

                if (errors.length) {
                    configs.onError(errors);
                }
                configs.onChange(result);
            }
        },
        directives: {
            file: {
                inserted (el, binding) {
                    let options = binding.value;
                    require(['mOxie'], (lib) => {
                        if (!window.moxie) {
                            window.moxie = lib;
                            moxie.core.utils.Env.swf_url = require('mOxie/bin/flash/Moxie.min.swf');
                        }
                        let input = new moxie.file.FileInput({
                            browse_button: el,
                            container: el.parentNode,
                            multiple: options.multiple,
                            accept: [{ extensions: options.extensions }]
                        });
                        input.onchange = (e) => {
                            options.handleChange(e);
                        };
                        input.onready = function (e) {
                            window.addEventListener('resize', () => {
                                options.refresh(input);
                            }, false);
                            options.refresh(input);
                        };
                        input.init();
                        __inputs[input.uid] = input;
                        el.setAttribute('id', input.uid);
                    });
                },
                update (el, binding) {
                    let id = el.getAttribute('id');
                    if (id) {
                        let options = binding.value;
                        let input = __inputs[id];
                        options.refresh(input, ['multiple', 'extensions']);
                    }
                }
            }
        }, // directives
        updated () {
        }
    };
</script>

<style lang="less">
    .ratio-box > .ratio-content > .moxie-file {
        display: block;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        border: 1px dashed #bfcbd9;
        -webkit-user-select: none;
         -khtml-user-select: none;
           -moz-user-select: none;
             -o-user-select: none;
                user-select: none;
        -webkit-user-drag: none;
         -khtml-user-drag: none;
           -moz-user-drag: none;
             -o-user-drag: none;
                user-drag: none;
        &:before, &:after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
        }
        &:before {
            width: 50%;
            height: 1px;
            border-top: 1px dashed #bfcbd9;
            transform: translateX(-50%);
            -ms-transform: translateX(-50%);
        }
        &:after {
            width: 1px;
            height: 50%;
            border-left: 1px dashed #bfcbd9;
            transform: translateY(-50%);
            -ms-transform: translateY(-50%);
        }
        &:focus {
            outline: none;
        }
        &.init {
            cursor: wait;
        }
        &.disabled, &.disabled:focus, &.disabled:active, &.disabled:hover {
            cursor: not-allowed;
            &, &:before, &:after {
                background-color: #eef1f6;
                border-color: #d1dbe5;
            }
        }
    } // .ratio-box > .ratio-content > a.moxie-file
</style>
