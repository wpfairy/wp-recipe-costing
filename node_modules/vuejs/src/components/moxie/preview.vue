<template>
    <nftn-moxie-container
        v-bind:ratio="computedConfigs.ratio">
        <slot name="before"
            v-bind:configs="computedConfigs"></slot>
        <slot>
            <span class="moxie-preview"
                ref="preview"
                v-bind:class="[computedConfigs.bgSize, { error: file.error }]"
                v-bind:style="computedStyles"
                v-on:click="handleClick()">
            </span>
        </slot>
        <slot name="after"
            v-bind:configs="computedConfigs"></slot>
    </nftn-moxie-container>
</template>

<script>
    import NftnMoxieContainer from './container';

    let bgSizeValidate = (value) => ['cover', 'contain'].indexOf(value) !== -1;
    let bgSize = (value) => bgSizeValidate(value) ? value : 'cover';

    export default {
        name: 'nftn-moxie-preview',
        components: {
            NftnMoxieContainer
        },
        props: {
            file: {
                type: [Number, String, Object],
                default: '',
                required: true
            },
            ratio: {
                type: String,
                default: '1:1'
            },
            mode: {
                type: String,
                default: 'bg'
            },
            bgSize: {
                type: String,
                default: 'cover', // 'cover' or 'contain'
                validator (value) {
                    return bgSizeValidate(value);
                }
            },
            urlAppend: {
                type: String,
                default: ''
            },
            previewAppend: {
                type: String,
                default: ''
            },
            // 功能相关
            type: {
                type: String,
                default: '*'
            },
            data: {
                type: null
            },
            // 事件相关
            onClick: {
                type: Function,
                default (file, data) {
                    console.log(file, data);
                }
            },
            onError: {
                type: Function,
                default (message) {
                    console.warn(message);
                }
            },
            // 其他
            configs: {
                type: Object,
                default () { return {}; }
            }
        },
        data () {
            return {
                preview: null,
                url: null,
                size: null,
                state: 'init'
            };
        },
        computed: {
            computedConfigs () {
                let configs = Object.assign({}, this.$props, this.configs, {
                    mode: 'bg',
                    url: this.url || this.preview,
                    preview: this.preview || this.url
                });
                configs.bgSize = this.size || bgSize(this.bgSize);
                Object.keys(configs).forEach(key => {
                    if (typeof configs[key] === 'function') {
                        configs[key] = configs[key].bind(this);
                    }
                });
                return configs;
            },
            computedStyles () {
                let configs = this.computedConfigs;
                let styles = {};
                if (configs.preview) {
                    let extension = moxie.core.utils.Mime.getFileExtension(configs.preview);
                    let url = 'http://via.placeholder.com/' + configs.ratio.replace(':', '00x') + '00?text=' + extension;
                    let unknowUrl = '';
                    styles.backgroundImage = 'url("' + configs.preview + '"), url("' + url + '"), url("' + unknowUrl + '")';
                    styles.backgroundColor = '#ffffff';
                    styles.backgroundRepeat = 'no-repeat';
                    styles.backgroundPosition = 'center';
                    styles.backgroundSize = configs.bgSize;
                }
                return styles;
            }
        },
        methods: {
            buildPreview () {
                if (window.moxie) {
                    let file = this.computedConfigs.file;
                    this.state = 'loading';
                    if (!(file instanceof window.moxie.file.File)) {
                        this.url = (file.url || file) + this.urlAppend;
                        this.preview = (file.preview || file) + this.previewAppend;
                    } else {
                        let mime = moxie.core.utils.Mime.getFileMime(file.name) || moxie.core.utils.Mime.getFileExtension(file.name);
                        let reader = new moxie.file.FileReader();
                        reader.onload = () => {
                            this.url = reader.result;
                            if (mime.indexOf('image/') === 0) {
                                this.size = this.bgSize;
                                this.preview = reader.result;
                            } else {
                                this.size = 'cover';
                                this.preview = 'http://via.placeholder.com/' + this.computedConfigs.ratio.replace(':', '00x') + '00?text=' + mime;
                            }
                            this.state = 'loaded';
                        };
                        reader.onerror = () => {
                            this.state = 'error';
                            this.onError(file.name + '文件读取失败。');
                        };
                        reader.readAsDataURL(file);
                    }
                }
            },
            handleClick () {
                this.onClick(this.file, this.data);
            }
        },
        created () {
            require(['mOxie'], (lib) => {
                window.moxie = lib;
                moxie.core.utils.Env.swf_url = require('mOxie/bin/flash/Moxie.min.swf');
                this.buildPreview();
            });
        },
        updated () {
            this.buildPreview();
        },
        mounted () {
        }
    };
</script>

<style lang="less">
    .ratio-box > .ratio-content > .moxie-preview {
        display: block;
        width: 100%;
        height: 100%;
        background-color: #ffffff;
        border: 1px solid #bfcbd9;
        -webkit-user-select: none;
         -khtml-user-select: none;
           -moz-user-select: none;
             -o-user-select: none;
                user-select: none;
        -webkit-user-drag: none;
         -khtml-user-drag: none;
           -moz-user-drag: none;
             -o-user-drag: none;
                user-drag: none;
        background-repeat: no-repeat;
        background-position: center;
        background-size: cover;
        &.contain {
            background-size: contain;
        }
        &.error {
            border-color: rgb(255, 73, 73);
        }
    }
</style>
